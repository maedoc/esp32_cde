name: CAN NVS Component Tests

on:
  push:
    branches: [ main, develop, 'claude/**' ]
    paths:
      - 'components/can_nvs/**'
      - '.github/workflows/can_nvs_test.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'components/can_nvs/**'
      - '.github/workflows/can_nvs_test.yml'

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Build CAN NVS tests
      uses: espressif/esp-idf-ci-action@v1
      with:
        esp_idf_version: v5.1.2
        target: esp32
        path: 'components/can_nvs/test'
        command: |
          idf.py build

    - name: Archive test artifacts
      uses: actions/upload-artifact@v3
      with:
        name: can-nvs-test-build
        path: |
          components/can_nvs/test/build/
        retention-days: 7

  qemu-test:
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install QEMU
      run: |
        sudo apt-get update
        sudo apt-get install -y qemu-system-xtensa

    - name: Build and run tests with QEMU
      uses: espressif/esp-idf-ci-action@v1
      with:
        esp_idf_version: v5.1.2
        target: esp32
        path: 'components/can_nvs/test'
        command: |
          idf.py build
          timeout 60 idf.py qemu monitor || echo "QEMU test completed or timed out"

  component-validation:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Validate component structure
      run: |
        echo "Validating CAN NVS component structure..."

        # Check required files
        test -f components/can_nvs/CMakeLists.txt || exit 1
        test -f components/can_nvs/include/can_nvs.h || exit 1
        test -f components/can_nvs/src/can_nvs.c || exit 1
        test -f components/can_nvs/test/main/test_can_nvs.c || exit 1
        test -f components/can_nvs/README.md || exit 1

        echo "All required files present!"

    - name: Check code style
      run: |
        echo "Checking for basic code quality..."

        # Check for common issues
        ! grep -r "TODO\|FIXME" components/can_nvs/src/ || echo "Found TODOs/FIXMEs"

        echo "Code style check completed"
